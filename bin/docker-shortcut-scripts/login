#!/usr/bin/env bash

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
ENV_CONFIG_FILE="${SCRIPT_DIR}/../.env"

. "${ENV_CONFIG_FILE}"

POSSIBLE_PREDEFINED_DOCKER_CONTAINERS=(
    "${SPRING_DOCKER_PREFIX}" "${ANGULAR_DOCKER_PREFIX}"
)
############################################################
# Help                                                     #
############################################################
help() {
    echo ""
    echo -e "Log in to a running docker container. Used for debugging and exploratory purposes." | fmt
    echo
    echo -e "Log in to a running docker container given the container ID or pre-loaded docker service and run the command provided as an option. The default command is /bin/ash if no [-c] command is provided." | fmt
    echo
    echo -e "Ref: https://docs.docker.com/engine/reference/commandline/exec/"
    echo -e "Ref: https://docs.docker.com/engine/reference/commandline/ps/"
    echo
    echo -e "Usage: $0 [ -c | -h | -i | -u ]" | fmt
    echo -e "\t-c\t Shell command(s) to run from the image's shell once logged in (must be passed in double quotes)." | fmt
    echo -e "\t\tExamples:" | fmt
    echo -e "\t\t$ -c \"ls\"" | fmt
    echo -e "\t-h\t Display this help message" | fmt
    echo -e "\t-i\t Runing image container ID (can be pulled from running 'docker ps')" | fmt
    echo -e "\t-u\t Pre-loaded Docker service. Must be one of these values: " "${POSSIBLE_PREDEFINED_DOCKER_CONTAINERS[@]}" | fmt
    echo
}

############################################################
############################################################
# Main Program                                             #
############################################################
############################################################

CUSTOM_COMMAND="/bin/ash"
# DOCKER_COMMAND=""

while getopts "c:hi:u:" opt; do
    case $opt in
    u)
        if [[ ${POSSIBLE_PREDEFINED_DOCKER_CONTAINERS[*]} =~ ${OPTARG} ]]; then
            if [[ ${OPTARG} == "${SPRING_DOCKER_PREFIX}" ]]; then
                RUNNING_IMAGE_CONTAINER_ID=${SPRING_DOCKER_RUNNING_IMAGE_CONTAINER_ID}
            elif [[ ${OPTARG} == "${ANGULAR_DOCKER_PREFIX}" ]]; then
                RUNNING_IMAGE_CONTAINER_ID=${ANGULAR_DOCKER_RUNNING_IMAGE_CONTAINER_ID}
                CUSTOM_COMMAND="/bin/bash"
            fi
        else
            listAvailableOptionsErrorMessage "${POSSIBLE_PREDEFINED_DOCKER_CONTAINERS[@]}"
        fi
        ;;
    c)
        CUSTOM_COMMAND=$OPTARG
        echo "Running this command once logged in to the container: ${CUSTOM_COMMAND}"
        ;;
    h)
        help
        exit 0
        ;;
    i)
        RUNNING_IMAGE_CONTAINER_ID=$OPTARG
        echo "Attempting to access Container ID: ${RUNNING_IMAGE_CONTAINER_ID}"
        ;;
    \?)
        echo "Invalid option: -$OPTARG" >&2
        help
        exit 1
        ;;
    :)
        echo ""
        echo "Option -$OPTARG requires an argument." >&2
        help
        exit 1
        ;;
    esac
done

docker exec -it "${RUNNING_IMAGE_CONTAINER_ID}" sh -c "${CUSTOM_COMMAND}"
