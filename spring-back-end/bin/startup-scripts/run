#!/usr/bin/env bash

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
ENV_CONFIG_FILE="${SCRIPT_DIR}/../.env"

. "${ENV_CONFIG_FILE}"

############################################################
# Help                                                     #
############################################################
help() {
  echo ""
  echo -e "Run the Spring-Boot jar locally." | fmt
  echo ""
  echo -e "Usage: $0 [-h] | [-p profile]" | fmt
  echo -e "\t-h\t Display this help message" | fmt
  echo -e "\t-p\t Spring-Boot profile you want to use. Default is local." | fmt
  echo ""
}

############################################################
############################################################
# Main Program                                             #
############################################################
############################################################

PROFILE="local"

while getopts "hp:" opt; do
  case $opt in
  h)
    help
    exit 0
    ;;
  p)
    PROFILE=${OPTARG}
    echo "Setting Spring profile to ${PROFILE}"
    echo
    ;;
  \?)
    echo "Invalid option: -$OPTARG" >&2
    help
    exit 1
    ;;
  :)
    echo ""
    echo "Option -$OPTARG requires an argument." >&2
    help
    exit 1
    ;;
  esac
done

SSL_FILE_TYPE=".p12z"

echo
echo "Checking to make sure there is an SSL p12 file in the repo."
echo

if [[ $(ls -A "${SSL_KEYSTORE_DIR}"/*"${SSL_FILE_TYPE}"*) ]]; then
  echo "There is a ${SSL_FILE_TYPE} file, proceeding."
  echo
else
  echo
  echo -e "We didn't find a ${SSL_FILE_TYPE} in ${SSL_KEYSTORE_DIR}. Without this file, SSL will not be enabled; and when you try and run the app, you'll get an error indicating the server.ssl.key-store file referenced in the application-local.properties could not be found." | fmt
  echo
  echo -e "To generate this file, run the 'enable-localhost-https' script in ${SCRIPT_DIR}/../ssl"
  echo
  read -r -p "Do you want to try and run the jar anyway? (y/n) " yn
  case $yn in
  y | Y)
    echo "OK. Continuing..."
    ;;
  n | N)
    echo "OK. Quitting here..."
    exit 0
    ;;
  *)
    echo "invalid response"
    exit 1
    ;;
  esac
fi

exit

java -Dspring.profiles.active="${PROFILE}" -jar "${SCRIPT_DIR}"/../../pjl-application/pjl-application-core/target/pjl-application-core.jar
